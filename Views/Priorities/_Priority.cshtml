@using System.Diagnostics.Eventing.Reader
@using MyTasks.Controllers
@using MyTasks.Models
@model MyTasks.Models.Priority

<div id="@("priority-" + Model.ID)" class="col-md-4">
    <div class="row">
        <div class="col-md-6">
            <h2 style="margin-top: 0px">
                @Html.ActionLink(Model.Title, "Details", new { id = Model.ID }, new { @style = "color: black" })
            </h2>
        </div>
        <div class="col-md-6">
            <div class="container">
                @Html.ActionLink("X", "Delete", new { id = Model.ID }, new { @class = "btn btn-danger", @style = "color:white" })
            </div>
        </div>
    </div>

    @foreach (var task in Model.Tasks)
    {
        @functions{
            string GetTargetPartialId(Task task, string action)
            {
                var controller = new PrioritiesController();
                var priorities = controller.GetSortedPriorities();
                var pos = priorities.IndexOf(controller.GetPriorityById(task.PriorityId));
                try
                {
                    if (action == "Up")
                        return $"partial-{priorities.ElementAt(pos + 1).ID}";
                    else
                        return $"partial-{priorities.ElementAt(pos - 1).ID}";
                }
                catch (Exception)
                {
                    return $"partial-{priorities.ElementAt(pos).ID}";
                }
            }

            AjaxOptions GetAjaxOptions(Task task, int modelId, string action)
            {
                return new AjaxOptions
                {
                    HttpMethod = "GET",
                    InsertionMode = InsertionMode.Replace,
                    UpdateTargetId = GetTargetPartialId(task, action),
                    OnBegin = $"removeTask({modelId}, {task.ID});"
                };
            }
        }

        <div id="@("task-" + task.ID)" class="row" style="padding-left: 15px; padding-bottom: 10px">
            <div class="col-md-1" style="padding: 0px">
                
                @Ajax.ActionLink("+", "ChangeTaskPriority", new {id = task.ID, act = "Up"},
                    GetAjaxOptions(task, Model.ID, "Up"),
                    new {@class = "btn btn-success btn-circle"})

                @Ajax.ActionLink("-", "ChangeTaskPriority", new {id = task.ID, act = "Down"},
                    GetAjaxOptions(task, Model.ID, "Down"),
                    new {@class = "btn btn-danger btn-circle"})
            </div>
            <div class="col-md-11" style="padding: 0px">
                <a href="@("/Tasks/Details?id=" + task.ID)">@task.Name</a>
            </div>
        </div>
    }
</div>
